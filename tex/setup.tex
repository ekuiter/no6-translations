% THIS DOCUMENT REQUIRES LuaLaTeX TO COMPILE!
% Inspired by Overleaf's fiction novel template (https://de.overleaf.com/latex/templates/fiction-novel/pjdthvgdtsfy) and HPMOR (https://github.com/rjl20/hpmor, https://github.com/knuesel/hpmor). Can be used with for any novel with little customization.

% PACKAGES
\documentclass[11pt,twoside,onecolumn,openright,extrafontsizes]{memoir}
\usepackage[bookmarks=true,unicode=true,pdfborder={0 0 0},breaklinks={true},pdfencoding=auto,hidelinks,pdfusetitle]{hyperref}
\usepackage{microtype} % for micro-typographical adjustments
\usepackage{setspace} % for line spacing
\usepackage{lettrine} % for drop caps and awesome chapter beginnings
\usepackage{titlesec} % for manipulation of chapter titles
\usepackage{fontspec} % enables loading TTF fonts (requires LuaLaTeX!)
\usepackage[style=english]{csquotes} % proper opening and closing quotes
\usepackage[framemethod=TikZ]{mdframed} % for box in chapter 2
\usepackage{xspace} % adds spaces after commands
\usepackage[xspace]{ellipsis} % better ellipses (...)
\usepackage{calc} % calculate text width for epigraphs

% LAYOUT
\setstocksize{205mm}{135mm} % size of paper fed to the printer
\settrimmedsize{199mm}{129mm}{*} % size of paper after trimming the edges
\settrims{3mm}{3mm} % amount trimmed from the top and fore-edge
\settypeblocksize{164mm}{*}{*} % size of main text
\setlrmarginsandblock{15mm}{11mm}{*}
\setulmargins{*}{*}{1.2} % ratio between up and down margins
\setheadfoot{1\baselineskip}{2\baselineskip} % header height and skip from text bottom to footer bottom
\setheaderspaces{*}{*}{*} % equal spacing above and below header
\settypeoutlayoutunit{mm} % print dimensions in millimeters in compilation output

% FRONT MATTER
% first page
\newcommand*\halftitlepage{\begingroup
	\begin{center}
		\vspace*{0.1\textheight}
		\rule{\textwidth}{0in}\par
		{\Large\sffamily\thetitle\par}
		\rule{\textwidth}{0in}\par
		\vfill
	\end{center}
	\endgroup}

% second page
\newcommand*{\addbook}[2]{
	{\bfseries #1}\par
	\vspace*{0.5mm}
	#2\bigskip\par}
\newcommand*\seriespage{\begingroup
	\thispagestyle{empty}
	\vspace*{-2cm}
	\begin{vplace}
		\begin{center}
			{\small\sffamily\thetitle}
			\par
			\vspace*{1cm}
			\normalsize
			\series
		\end{center}
	\end{vplace}
	\endgroup}

% third page
\newcommand*\titlepage{\begingroup
	\begin{center}
		\vspace*{0.1\textheight}
		\rule{\textwidth}{0in}\par
		\includegraphics[width=0.5\textwidth]{images/no6}
		\rule{\textwidth}{0in}\par
		{\Large\booktitle\par}
		\vspace{\stretch{3.5}}
		{A novel by\\\Large\textit\theauthor\par}
		\vspace{\stretch{1.2}}
		{{\small Translated by}\\\textit\translator\par}
		\vspace{\stretch{0.4}}
		{{\small Original published by}\\\textit\publisher\par}
	\end{center}
	\endgroup}

% fourth page
\newcommand{\copyrightpage}[1]{\noindent{\small #1}}

% BACK MATTER
% We want the total number of real pages (sheets) to be a multiple of 4, and we
% want the colophon to land on the last page (which will necessarily be an even
% page). So we might need to insert up to 3 blank pages before the colophon.
% First we calculate the current page number modulo 4:
\makeatletter
\newcommand{\ensuredivisiblebyfour}{\clearpage
	\count@=\c@sheetsequence
	\@tempcnta=\count@
	\divide\@tempcnta by 4
	\multiply\@tempcnta by 4
	\count@=\numexpr\count@-\@tempcnta\relax
	\ifnum\count@>0
	\pagestyle{empty}
	\loop\ifnum\count@<4
	\null\clearpage
	\advance\count@\@ne
	\repeat
	\fi}
\makeatother
\newcommand*\colophonpage{\ensuredivisiblebyfour
	{\null\vfil%
		\thispagestyle{empty}\noindent\rightskip=0pt plus 1fil\leftskip=0pt plus 1fil\parfillskip=0pt%
		\vbox{
			\parshape 1 0em 21.5em
			\noindent
			\leftskip=0pt\rightskip=0pt\parfillskip=0pt plus 1fil{}\emph{\colophon}}\vskip\footskip%
		\vfil\vfil
		\newpage}}

% PARTS & CHAPTERS
% part title pages
\renewcommand{\printpartname}{} % remove part number from part title pages
\renewcommand{\partnamenum}{}
\renewcommand{\printpartnum}{}
\renewcommand{\midpartskip}{}
\renewcommand{\parttitlefont}{\normalfont\bfseries\sffamily\huge}
\makeatletter % allow additional text on part title page (see \mypart)
\renewcommand{\beforepartskip}{\null\vskip4cm}
\renewcommand{\afterpartskip}{\par\vskip1cm%
	\@afterindentfalse\@afterheading}
\makeatother

% custom part title page, allows additional text on part title page and the following page
\newcommand{\mypartnoclear}[3]{
	\nopartblankpage
	\part{#1}
	{#2}
	\thispagestyle{empty}
	\newpage
	\thispagestyle{empty}
	\begin{vplace}[.27]
		\itshape\small\centering
		\parindent=0pt
		#3
	\end{vplace}
	\clearpage}
\newcommand{\mypart}[3]{\clearpage
	\thispagestyle{empty}
	\mbox{}
	\makeatletter
	\clearpage \if@twoside \ifodd \c@page \else \hbox {}\thispagestyle{empty}\newpage
	\if@twocolumn \hbox {}\thispagestyle{empty}\newpage  \fi \fi \fi
	\makeatother
	\mypartnoclear{#1}{#2}{#3}}

% chapter title pages
\titleformat
	{\chapter} % redefine \chapter command
	[display]
	{\normalfont\scshape\sffamily} % number and title style
	{\HUGE\centering\thechapter} % number style
	{0pt}
	{\vspace{18pt}\huge\centering\MakeLowercase} % title style
	[\vspace{28pt}]

% subsections and paragraphs
\titleformat{\subsection}{\sffamily\large\bfseries}{\thesubsection}{1em}{}
\titleformat{\paragraph}[runin]{\sffamily\normalsize\bfseries}{\theparagraph}{1em}{}

% first letter of chapter
\setcounter{DefaultLines}{1}
\renewcommand{\DefaultLoversize}{0}
\renewcommand{\DefaultLraise}{0}

% chapter epigraphs
\setlength{\epigraphwidth}{\textwidth}
\setlength{\epigraphrule}{0pt}
\newcommand{\myepigraph}[2]{\epigraph{\sffamily\itshape #1}{\vspace{0.8ex}\rule{\widthof{#2}}{0.5pt}\vspace{-0.4ex}\break\sffamily\textsc{#2}}}
\renewcommand{\textflush}{flushright}
\renewcommand{\beforeepigraphskip}{-2cm}
\renewcommand{\afterepigraphskip}{-0.2cm}

% TABLE OF CONTENTS
\renewcommand{\contentsname}{\normalfont\scshape\textsf{\MakeLowercase Contents}}
\renewcommand{\cftchapterfont}{\normalfont}
\renewcommand{\cftchapterpagefont}{\normalfont}
\renewcommand{\printtoctitle}{\centering\huge}
\renewcommand{\partnumberline}[1]{\hspace{\cftpartnumwidth}} % remove part numbers, indent nonetheless
\setpnumwidth{2em}
\setlength{\cftbeforepartskip}{2em}
\setlength{\cftbeforechapterskip}{0.5em}
\makeatletter
\@addtoreset{chapter}{part} % reset chapter count for each part
\makeatother
\newcommand{\mytoc}{\pagestyle{bare}
	\tableofcontents*
	\clearpage
	\pagestyle{empty}
	\mbox{}
	\cleardoublepage}

% HEADER AND FOOTER
\headsep = 0.16in % sensible margins
\nouppercaseheads % do not uppercase chapter titles
\newcommand{\headerstyle}{\small\scshape\MakeLowercase} % basic font style for headers

% enable use of part and subsection titles in headers
\let\Partmark\partmark
\def\partmark#1{\def\Partname{#1}\Partmark{#1}}
\let\Subsectionmark\subsectionmark
\def\subsectionmark#1{\def\Subsectionname{#1}\Subsectionmark{#1}}

% first pages of chapters are internally assigned the plain style, which has no headers by default
% additionally, remove footers on such pages
\makepagestyle{plain}
\makeevenfoot{plain}{}{}{}
\makeoddfoot{plain}{}{}{}

% header/footer style for the main text
\makepagestyle{main}
\makepsmarks{main}{\createmark{chapter}{left}{nonumber}{}{}} % define left mark as chapter title only (no number)
\makeevenhead{main}{}{\textsf{\headerstyle{\Partname, Chapter \thechapter}}}{} % part name/chapter number on every verso page
\makeoddhead{main}{}{\textsf{\headerstyle\leftmark}}{} % chapter title (see left mark above) on every recto page
\makeevenfoot{main}{}{\textsf{\small\thepage}}{} % page number
\makeoddfoot{main}{}{\textsf{\small\thepage}}{}

% like main, but includes only page numbers
\copypagestyle{bare}{main}
\makeevenhead{bare}{}{}{}
\makeoddhead{bare}{}{}{}

% like main, but only includes part name on every verso page (no chapter number)
\copypagestyle{part}{main}
\makeevenhead{part}{}{\sffamily\headerstyle\Partname}{}

% like part, but includes subsection title on every recto page (no chapter title)
\copypagestyle{subsection}{part}
\makeoddhead{subsection}{}{\sffamily\headerstyle\Subsectionname}{}

% TEXT
% line spacing
\providecommand{\LineSpread}{1.11}
\setSingleSpace{\LineSpread}
\SingleSpace

% no indent and slight skip for paragraphs
\setlength{\parindent}{0pt}
\setlength{\parskip}{1.6pt plus 1.1pt minus 0.4pt} % use glue length to make paragraphs stretchable
\hyphenation{Shi-on Ne-zu-mi Inu-ka-shi Ri-ki-ga Ka-ran Sa-fu Yo-ming Li-li}

\MakeOuterQuote{"} % automatic open and closing quotes
\xspaceaddexceptions{"} % do not add a space between ellipsis and quote
\newcommand*{\el}{\kern \ellipsisgap\ldots} % ellipsis (...)

% FONTS
% URW Garamond No. 8, 10.5 pt
\setmainfont[
	, ExternalLocation=fonts/garamond/
	, Ligatures={Common,TeX}
	, UprightFont=*-Regular
	, ItalicFont=*-Italic
	, BoldFont=*-Bold
	, BoldItalicFont=*-Bold-Italic
	, Scale=0.95
]{GaramondNo8}

% Alegreya Sans, 10.5 pt
\setsansfont[
	, ExternalLocation=fonts/alegreya-sans/
	, Ligatures={Common,TeX}
	, UprightFont=*-Regular
	, ItalicFont=*-Italic
	, BoldFont=*-Bold
	, BoldItalicFont=*-BoldItalic
	, Scale=0.95
	, UprightFeatures={SmallCapsFont={*SC-Regular}}
	, BoldFeatures={SmallCapsFont={*SC-Bold}}
	, ItalicFeatures={SmallCapsFont={*SC-Italic}}
	, BoldItalicFeatures={SmallCapsFont={*SC-BoldItalic}}
]{AlegreyaSans}

% memos
\newfontface\karan[ExternalLocation=fonts/]{joehand-2}
\newfontface\nezumi[ExternalLocation=fonts/,Scale=1.1]{sunday-monday}
\newfontface\shion[ExternalLocation=fonts/]{biro-script}
\newfontface\inukashi[ExternalLocation=fonts/]{gabo-4}
\newfontface\sasori[ExternalLocation=fonts/]{lipsum}

% ENVIRONMENTS
% used in chapter 2
\newenvironment{boxed}[1]{%
	\mdfsetup{%y
		frametitle={%
			\tikz[baseline=(current bounding box.east),outer sep=0pt]
			\node[anchor=east,rectangle,fill=gray!40,font=\sffamily]
			{\strut \ \ #1\ \ };}}%
	\mdfsetup{innertopmargin=6pt,innerbottommargin=10pt,%
		linecolor=gray!40,linewidth=1.5pt,topline=true,%
		frametitleaboveskip=\dimexpr-\ht\strutbox\relax
	}
	\vspace{-1cm}\begin{mdframed}[font=\sffamily]\relax}{\end{mdframed}}

% COMMANDS
\newcommand{\mybreak}{\myspace
	\fancybreak{*\qquad*\qquad*}
	\myspace}

\newcommand{\standout}[1]{\myspace
	{\sffamily \textsc{#1}}
	\myspace}

\newcommand{\poem}[1]{
	\begin{center}
		\sffamily
		\emph{#1}
	\end{center}}

\newcommand{\memo}[2]{
	\myspace
	{#1 #2}
	\myspace
}

\newcommand{\memosmall}[2]{
	{#1 #2}
}

\newcommand{\jp}[1]{{\fontspec{Batang} #1}} % on Windows, this works out-of-the-box to render Japanese characters
\newcommand{\myspace}{\plainbreak{1}}
\newcommand{\myhref}[2]{{\small\texttt{\href{#1}{#2}}}}
\newcommand{\mysmallhref}[2]{{\footnotesize\texttt{\href{#1}{#2}}}}
\newcommand{\tocbreak}{\addtocontents{toc}{\protect\newpage\par~\par}}
\newcommand{\elyurias}[1]{{\sffamily\emph{#1}}}

% APPLY LAYOUT
\checkandfixthelayout
